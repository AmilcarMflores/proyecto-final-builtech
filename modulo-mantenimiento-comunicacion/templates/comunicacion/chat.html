{% extends 'comunicacion/base.html' %}

{% block comunicacion_content %}
<div class="chat-container">
    <div class="chat-messages" id="messages"></div>
    
    <form id="chat-form" class="chat-form">
        <input 
            type="text" 
            id="message-input" 
            placeholder="Escribe un mensaje..." 
            autocomplete="off"
            required
        >
        <button type="submit" class="btn btn-primary">Enviar</button>
    </form>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const username = "{{ current_username }}"; 
    const socket = io();
    
    const messagesContainer = document.getElementById('messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');

    socket.on('connect', () => {
        console.log('Conectado al servidor');
        socket.emit('join_general_chat');
    });

    socket.on('load_messages', (messages) => {
        messagesContainer.innerHTML = '';
        messages.forEach(msg => {
            addMessage(msg);
        });
        scrollToBottom();
    });

    socket.on('new_message', (message) => {
        addMessage(message);
        scrollToBottom();
    });

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('send_message', {
                message: message,
                username: username
            });
            messageInput.value = '';
        }
    });

    function addMessage(msg) {
        const isOwnMessage = msg.username === username;
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isOwnMessage ? 'own-message' : ''}`;
        
        messageDiv.innerHTML = `
            <div class="message-header">
                <strong>${escapeHtml(msg.username)}</strong>
                <small>${formatTime(msg.timestamp)}</small>
            </div>
            <div class="message-content">${escapeHtml(msg.content)}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

<style>
    .chat-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        height: 600px;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
    }

    .chat-message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        max-width: 80%;
    }

    .chat-message.own-message {
        background: #e3f2fd;
        margin-left: auto;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
    }

    .message-header strong {
        color: #2c3e50;
    }

    .message-header small {
        color: #666;
    }

    .message-content {
        color: #333;
        word-wrap: break-word;
    }

    .chat-form {
        display: flex;
        padding: 1rem;
        background: white;
        border-top: 1px solid #ddd;
        gap: 0.5rem;
    }

    .chat-form input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 1rem;
    }

    .chat-form input:focus {
        outline: none;
        border-color: #3498db;
    }

    .chat-form button {
        padding: 0.75rem 1.5rem;
        border-radius: 20px;
    }
</style>
{% endblock %}